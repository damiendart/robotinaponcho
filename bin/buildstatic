#!/usr/bin/env node

const { promisify } = require('util');

const commander = require('commander');
const fse = require('fs-extra');
const glob = promisify(require('glob'));
const path = require('path');

const program = new commander.Command();

program.version('0.1.0');
program.option('-i, --input <dir>', 'specify input directory', './static_src').
    option('-o, --output <dir>', 'specify output directory', './public');
program.parse(process.argv);

const processors = [
  require('./processors/JavaScriptProcessor'),
  require('./processors/SassProcessor'),
  require('./processors/SVGProcessor'),
  require('./processors/TwigProcessor'),
];
const inputDirectory = path.resolve(program.input);
const outputDirectory = path.resolve(program.output);
let writtenFilesCount = 0;

glob('**/*', { cwd: inputDirectory, nodir: true }).then(files => {
  return Promise.all(files.map(file => {
    const applicableProcessors = processors.filter(processor => {
      return processor.INPUT_EXTENSION === path.extname(file);
    });

    if (applicableProcessors.length > 0) {
      return Promise.all(
          applicableProcessors.map(processor => {
            const inputFile = path.join(inputDirectory, file);
            const outputFile = path.join(outputDirectory, file)
              .replace(processor.INPUT_EXTENSION, processor.OUTPUT_EXTENSION);

            return fse.mkdirs(path.dirname(outputFile))
              .then(_ => fse.readFile(inputFile, 'utf8'))
              .then(fileContents => {
                return (new processor()).process(fileContents, inputFile, outputFile);
              })
              .then(output => {
                return fse.writeFile(outputFile, output);
              })
              .then(_ => {
                console.log(`[✔] Written "${outputFile}"`);
                writtenFilesCount++;
              })
              .catch(e => {
                console.error(`[✘] Unable to write "${outputFile}"`);
                console.error(`\n${e.toString()}`);
                process.exit(1);
              });
          }),
      );
    } else {
      const outputFile = path.join(outputDirectory, file);

      return fse.copy(path.join(inputDirectory, file), outputFile)
        .then(_ => {
          console.log(`[✔] Written "${outputFile}"`);
          writtenFilesCount++;
        })
        .catch(e => {
          console.error(`[✘] Unable to write "${outputFile}"`);
          console.error(`\n${e.toString()}`);
          process.exit(1);
        });
    }
  }));
})
  .then(_ => {
    console.log(`\n${writtenFilesCount} file(s) written!`);
  })
  .catch(e => {
    console.error(`[✘] An error has occurred!`);
    console.error(`\n${e.toString()}`);
    process.exit(1);
  });
