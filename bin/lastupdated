#!/usr/bin/env ruby
# Inserts "last modified" metadata into Markdown documents.
#
# This script is to be used as part of Git filter commands (see
# <https://git-scm.com/docs/gitattributes#_code_filter_code> for more
# information). Add the following to ".git/config":
#
#   [filter "addlastupdated"]
#     smudge = ./bin/addlastupdated %f
#     clean = ./bin/addlastupdated
#
# Copyright (C) 2013-2019 Damien Dart, <damiendart@pobox.com>.
# This file is distributed under the MIT licence. For more information,
# please refer to the accompanying "LICENCE" file.

if ARGV.empty?
  last_updated = '<i>See accompanying <code>bin/addlastupdated</code> script.</i>'
else
  last_updated =
    '<a data-timestamp="' + `git log -n 1 --pretty=format:%at #{ARGV[1]}` +
    '" href="https://github.com/damiendart/robotinaponcho/commit/' +
    `git log -n 1 --pretty=format:%H #{ARGV[1]}` + '">' +
    `git log -n 1 --date=short --pretty=format:%ad #{ARGV[1]}` + '</a>'
end

puts STDIN.read.gsub(
  /<li class="metadata-list__item"><b>Last Updated<\/b>:.*$/,
  "<li class=\"metadata-list__item\"><b>Last Updated</b>: #{last_updated}</li>"
)
