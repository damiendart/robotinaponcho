#!/bin/sh
# Gitweb installation script for Damien Dart's personal website.
#
# Copyright (C) 2013-2015 Damien Dart, <damiendart@pobox.com>.
# This file is distributed under the MIT licence. For more information,
# please refer to the accompanying "LICENCE" file.

GIT_VERSION="2.2.1"
trap "rm -rf git-$GIT_VERSION" EXIT
USAGE=`cat <<USAGE;
USAGE: $(basename $0) HTDOCS-FOLDER PROTECTED-FOLDER [MAKE-COMMAND]`
[ "$#" -lt 2 ] && { printf "Not enough operands\n$USAGE\n" >&2; exit 2; }
wget -O - https://github.com/git/git/archive/v${GIT_VERSION}.tar.gz | tar -zxf -
(cd git-${GIT_VERSION} && ${3:-make} bindir="/usr/local/bin" \
    GITWEB_CONFIG="${2%/}/gitweb_config.perl" \
    GITWEB_CSS="/assets/gitweb.css" GITWEB_FAVICON="/assets/git-favicon.png" \
    GITWEB_JS="/assets/gitweb.js" \
    GITWEB_HOMETEXT="${2%/}/gitwebindextext.html" \
    GITWEB_LOGO="/assets/git-logo.png" \
    GITWEB_PROJECTROOT="${1%/}/git" \
    gitwebdir="${1%/}/git" gitweb install-gitweb &&
    mv ${1%/}/git/static/* ${1%/}/assets && rm -fr ${1%/}/git/static)
patch ${1%/}/git/gitweb.cgi <<'PATCH'
--- Original
+++ Modified
@@ -4066,7 +4066,7 @@
 <head>
 <meta http-equiv="content-type" content="$content_type; charset=utf-8"/>
 <meta name="generator" content="gitweb/$version git/$git_version$mod_perl_version"/>
-<meta name="robots" content="index, nofollow"/>
+<meta name="robots" content="noindex, nofollow"/>
 <title>$title</title>
 EOF
 	# the stylesheet, favicon etc urls won't work correctly with path_info
PATCH
cat << 'INDEX' > ${2%/}/gitwebindextext.html
<pre>Here are a bunch of read-only Git repository; at the moment the only
repositories here are mirrors of those found on <a href="https://github.com/damiendart">my public GitHub
profile</a>. These mirrors should be no more than an hour out of date,
unless the <a href="/?p=robotinaponcho.git;a=blob_plain;f=www/private/mirrorgithub;hb=HEAD">mirroring script</a> I wrote broke.

-- <a href="/">Damien</a></pre>
INDEX
cat << 'CONFIG' > ${2%/}/gitweb_config.perl
$feature{"avatar"}{"default"} = ["gravatar"];
$home_link_str = "Damien Dart&rsquo;s Git Repositories";
$site_name = $home_link_str . ": Gitweb Edition;
CONFIG
