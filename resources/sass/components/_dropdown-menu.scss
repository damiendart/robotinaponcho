// Copyright (C) 2021 Damien Dart, <damiendart@pobox.com>.
// This file is distributed under the MIT licence. For more information,
// please refer to the accompanying "LICENCE" file.

@use "sass:math";
@use "../variables";
@use "../../../node_modules/toolbox-sass";

.dropdown-menu {
  $animation-duration: 0.125s;
  $border-radius: math.div(variables.$base-line-height, 4);

  border-radius: $border-radius $border-radius 0 0;
  cursor: default;
  display: inline-block;
  position: relative;

  @media (hover: hover) {
    // Pre-Blink Microsoft Edge and Internet Explorer do not support the
    // ":focus-within" pseudo-class; if we include the pseudo-class in a
    // group of selectors those browsers ignore the rule set.
    &:focus-within > &__lists {
      opacity: 1;
      right: math.div(variables.$base-line-height, -2);
      transform: none;

      &::before {
        transform: translateY(
            (variables.$base-line-height * -0.3125) + toolbox-sass.$base-one-pixel-in-rem
        );
        transition: transform $animation-duration ease-out;
        transition-delay: $animation-duration;
      }

      .dropdown-menu__lists__list__item {
        opacity: 1;
        transform: none;
      }
    }

    &:focus-within > &__title {
      opacity: 0.5;
    }

    &:hover > &__lists {
      opacity: 1;
      right: math.div(variables.$base-line-height, -2);
      transform: none;

      &::before {
        transform: translateY(
            (variables.$base-line-height * -0.3125) + toolbox-sass.$base-one-pixel-in-rem
        );
        transition: transform $animation-duration ease-out;
        transition-delay: $animation-duration;
      }

      .dropdown-menu__lists__list {
        &:last-child {
          @media #{toolbox-sass.$media-small-down} {
            @for $i from 1 through 10 {
              .dropdown-menu__lists__list__item:nth-child(#{$i}) {
                transition-delay: ($animation-duration * 1.75) + math.div($animation-duration, 4) * $i;
              }
            }
          }
        }
      }

      .dropdown-menu__lists__list__item {
        opacity: 1;
        transform: none;
        transition: opacity $animation-duration ease-out,
        transform $animation-duration ease-out;

        @for $i from 1 through 10 {
          &:nth-child(#{$i}) {
            transition-delay: math.div($animation-duration, 4) * $i;
          }
        }
      }
    }

    &:hover > &__title {
      opacity: 0.5;
    }
  }

  @media (hover: none) {
    &--open &__lists {
      opacity: 1;
      right: math.div(variables.$base-line-height, -2);
      transform: none;

      &::before {
        transform: translateY(
            (variables.$base-line-height * -0.3125) + toolbox-sass.$base-one-pixel-in-rem
        );
        transition: transform $animation-duration ease-out;
        transition-delay: $animation-duration;
      }

      .dropdown-menu__lists__list {
        &:last-child {
          @media #{toolbox-sass.$media-small-down} {
            @for $i from 1 through 10 {
              .dropdown-menu__lists__list__item:nth-child(#{$i}) {
                transition-delay: ($animation-duration * 1.5) + math.div($animation-duration, 4) * $i;
              }
            }
          }
        }
      }

      .dropdown-menu__lists__list__item {
        opacity: 1;
        transform: none;
        transition: opacity $animation-duration ease-out,
        transform $animation-duration ease-out;

        @for $i from 1 through 10 {
          &:nth-child(#{$i}) {
            transition-delay: math.div($animation-duration, 4) * $i;
          }
        }
      }
    }

    &--open &__title {
      opacity: 0.5;
    }

    @at-root {
      html:not(.javascript) & {
        margin: 0;
        padding: 0;
        width: 100%;

        &__title {
          display: none;
        }

        &__lists {
          background: transparent;
          border-radius: 0;
          box-shadow: none;
          color: variables.$colour-black;
          columns: 1;
          float: none;
          left: 0;
          margin: variables.$base-line-height 0 0 0;
          padding: 0;
          position: relative;
          opacity: 1;
          top: 0;
          transform: none;
          width: 100%;

          &::before {
            display: none;
          }

          &__list {
            &:first-child {
              margin: 0 0 math.div(variables.$base-line-height, 2);
            }

            &__item {
              opacity: 1;
              transform: none;
            }
          }
        }
      }
    }
  }

  // Internet Explorer 11 doesn't support interaction-related media
  // queries or SVG fragment identifiers.
  @media #{toolbox-sass.$media-ie-11} {
    &::after {
      $height: (variables.$base-line-height * 1.25) * math.div(14.14, 22.13);

      // The chevron implementation is different for Internet Explorer
      // 11 because, by default, using SVGs for background images can
      // result in blurry backgrounds. For more information, see
      // <https://ctidd.com/2015/svg-background-scaling>.
      background: url("icon-chevron.svg") no-repeat center;
      background-size: cover;
      content: "";
      height: $height;
      position: absolute;
      right: variables.$base-line-height * -0.3625;
      top: calc(50% - #{math.div($height, 2)});
      transform: scale(0.5);
      transition: opacity $animation-duration ease-out;
      transform-origin: center;
      width: variables.$base-line-height * 1.25;
    }

    &__title {
      background: none !important;
    }

    &:hover > &__lists {
      opacity: 1;
      right: math.div(variables.$base-line-height, -2);
      transform: none;

      .dropdown-menu__lists__list {
        &:last-child {
          @media #{toolbox-sass.$media-small-down} {
            @for $i from 1 through 10 {
              .dropdown-menu__lists__list__item:nth-child(#{$i}) {
                transition-delay: ($animation-duration * 1.5) + math.div($animation-duration, 4) * $i;
              }
            }
          }
        }
      }

      .dropdown-menu__lists__list__item {
        opacity: 1;
        // For Internet Explorer 11, setting the position property to a
        // value that isn't the default ("static") fixes a bug where an
        // item or two will sporadically disappear after the opacity
        // transition finishes. For more information (sorta), please see
        // <http://www.jacklmoore.com/notes/ie-opacity-inheritance/>.
        position: relative;
        transform: none;
        transition: opacity $animation-duration ease-out,
        transform $animation-duration ease-out;

        @for $i from 1 through 10 {
          &:nth-child(#{$i}) {
            transition-delay: math.div($animation-duration, 4) * $i;
          }
        }
      }
    }

    &:hover::after,
    &:hover > &__title {
      opacity: 0.5;
    }
  }

  &__title {
    background: url("icon-chevron.svg") no-repeat right center;
    background-size: variables.$base-line-height * 0.625;
    background-position-x: 100%;
    font-size: 100%;
    font-weight: bold;
    line-height: variables.$base-line-height;
    margin: 0;
    padding: 0 variables.$base-line-height 0 0;
    position: relative;
    transition: opacity $animation-duration ease-out;

    // Improve the user experience of the dropdown menu by adding a
    // "pointer-movement path" from the hamburger icon to the far-left
    // list of links. For more information, see
    // <https://css-tricks.com/dropdown-menus-with-more-forgiving-mouse-movement-paths/>.
    &:hover::before {
      bottom: 0;
      content: "";
      display: block;
      height: 300%;
      position: absolute;
      right: 100%;
      top: 0;
      transform: rotate(-25deg);
      transform-origin: 100% 0;
      width: 135%;
      z-index: 1;

      @media #{toolbox-sass.$media-medium-up} {
        transform: rotate(-10deg);
        width: 325%;
      }
    }

    &:hover::after {
      content: "";
      display: block;
      height: calc(100% + #{variables.$base-line-height});
      position: absolute;
      right: 0;
      top: 0;
      width: 100%;
    }
  }

  &__lists {
    background: variables.$colour-black;
    box-shadow: 0 toolbox-sass.$base-one-pixel-in-rem toolbox-sass.$base-one-pixel-in-rem rgba(variables.$colour-black, 0.1),
      0 (toolbox-sass.$base-one-pixel-in-rem * 2) (toolbox-sass.$base-one-pixel-in-rem * 2) rgba(variables.$colour-black, 0.1),
      0 (toolbox-sass.$base-one-pixel-in-rem * 4) (toolbox-sass.$base-one-pixel-in-rem * 4) rgba(variables.$colour-black, 0.1),
      0 (toolbox-sass.$base-one-pixel-in-rem * 8) (toolbox-sass.$base-one-pixel-in-rem * 8) rgba(variables.$colour-black, 0.1),
      0 (toolbox-sass.$base-one-pixel-in-rem * 16) (toolbox-sass.$base-one-pixel-in-rem * 16) rgba(variables.$colour-black, 0.1);
    border-radius: $border-radius;
    color: variables.$colour-white;
    opacity: 0;
    padding: variables.$base-line-height;
    position: absolute;
    right: 9999px;
    top: calc(100% + #{math.div(variables.$base-line-height, 2)});
    transform: translateY(math.div(variables.$base-line-height, -3));
    transition: opacity $animation-duration ease-out,
    transform $animation-duration ease-out;
    z-index: 1;

    &::before {
      border-bottom: (variables.$base-line-height * 0.3125) solid black;
      border-left: (variables.$base-line-height * 0.3125) solid transparent;
      border-right: (variables.$base-line-height * 0.3125) solid transparent;
      content: "";
      display: block;
      height: 0;
      position: absolute;
      right: math.div(variables.$base-line-height, 2);
      top: 0;
      width: 0;
    }

    @media #{toolbox-sass.$media-medium-up} {
      columns: 2;
      column-gap: variables.$base-line-height;
    }

    @media (hover: none) {
      @at-root {
        html:not(.javascript) & {
          right: 0;
        }
      }
    }

    &__list {
      break-inside: avoid;
      // This ensures that each list keeps to its own column in all
      // supported browsers.
      display: inline-table;
      list-style: none;
      margin: 0 0 math.div(variables.$base-line-height, 2) 0;
      white-space: pre;

      @media #{toolbox-sass.$media-medium-up} {
        margin: 0;
      }

      &:last-child {
        // This removes extra unwanted empty space from the bottom of
        // the dropdown in pre-Blink Microsoft Edge, because reasons.
        display: table;
        margin: 0;
      }

      &__item {
        opacity: 0;
        margin: 0;
        padding: 0;
        transform: translateX(math.div(variables.$base-line-height, -2));
        transition-delay: 0s;
        transition-duration: 0s;
      }
    }
  }
}
